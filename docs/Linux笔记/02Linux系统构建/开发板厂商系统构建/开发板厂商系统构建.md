[TOC]

## 1. 开发工具 


## arm 工具链介绍
ARM-A
1. arm-none-eabi
用于编译 ARM 架构的裸机系统（包括 ARM Linux 的 boot、kernel，不适用编译 Linux 应用 Application），一般适合 ARM7、Cortex-M 和 Cortex-R 内核的芯片使用，所以不支持那些跟操作系统关系密切的函数，比如fork(2)，他使用的是 newlib 这个专用于嵌入式系统的C库。
2. arm-none-linux-gnueabihf
主要用于基于ARM架构的Linux系统，可用于编译 ARM 架构的 u-boot、Linux内核、linux应用等。arm-none-linux-gnueabi基于GCC，使用Glibc库，经过 Codesourcery 公司优化过推出的编译器。arm-none-linux-gnueabi-xxx 交叉编译工具的浮点运算非常优秀。一般ARM9、ARM11、Cortex-A 内核，带有 Linux 操作系统的会用到。
3. aarch64-none-elf
4. aarch64-none-linux-gnu
linaro
arm-eabi
arm-linux-gnueabi
arm-linux-gnueabihf

ARM-RM
gcc-arm-none-eabi

交叉编译工具链的命名规则为：arch [-vendor] [-os] [-(gnu)eabi]

arch - 体系架构，如ARM，MIPS
vendor - 工具链提供商
os - 目标操作系统
eabi - 嵌入式应用二进制接口（Embedded Application Binary Interface）
根据对操作系统的支持与否，ARM GCC可分为支持和不支持操作系统，如

arm-none-eabi：这个是没有操作系统的，自然不可能支持那些跟操作系统关系密切的函数，比如fork(2)。他使用的是newlib这个专用于嵌入式系统的C库。
arm-none-linux-eabi：用于Linux的，使用Glibc

1. 配置交叉编译工具  
[http://www.arm.linux.org.uk](http://www.arm.linux.org.uk)  
手持设备[http://openhandhelds.org](http://openhandhelds.org)  
TI [http://linux.omap.com](http://linux.omap.com)  
[http://www.mvista.com](http://www.mvista.com)  
[https://www.linaro.org/](https://www.linaro.org/)  
[Downloads | GNU-A Downloads – Arm Developer](https://developer.arm.com/downloads/-/gnu-a) 
2. BootLoader
    Redboot
    ARMboot
    U-Boot
    Blob
    Bios-lt
    Bootldr
3. linux kernel
    [kernel](https://www.kernel.org/) 
4. 根文件系统构建工具
    [BusyBox](http://www.busybox.net/)
    [openembedded](http://www.openembedded.org/wiki/Main_Page)
    [OpenWrt](http://www.openwrt.org.cn/)
    [Buildroot](https://buildroot.org/)
    [Yocto](https://www.yoctoproject.org/)等等

## repo 工具
配置repo (国内清华源)
```bash
git clone https://mirrors.tuna.tsinghua.edu.cn/git/git-repo repo
```
配置REPO_URL
```bash
cd repo
vim repo
```
```shell
## REPO_URL = 'https://gerrit-googlesource.proxy.ustclug.org/git-repo'
REPO_URL = 'https://mirrors.tuna.tsinghua.edu.cn/git/git-repo/'
```
同步代码repo sync
```bash
repo sync -j4
repo sync -c
```


## 1. 源码获取
1. 源码下载
```bash
git clone https://e.coding.net/codebug8/repo.git
mkdir -p 100ask_myir_mini_imx6ull-sdk && cd 100ask_myir_mini_imx6ull-sdk

../repo/repo init -u  https://gitee.com/weidongshan/manifests.git -b linux-sdk -m imx6ull/100ask_myir-imx6ull_mini_linux4.9.88_release.xml  --no-repo-verify
../repo/repo sync -j4
```
2. 更新
```bash
../repo/repo sync -c
```
## 2. 交叉编译工具链配置
1. 打开
	```bash
	vim  ~/.bashrc
	```
	
2. 添加：
	```bash
	export ARCH=arm
	export CROSS_COMPILE=arm-linux-gnueabihf-
	export PATH=$PATH:/home/ubuntu/100ask_myir_mini_imx6ull-sdk/ToolChain/gcc-linaro-6.2.1-2016.11-x86_64_arm-linux-gnueabihf/bin
	```
	
3. 运行
	```bash
	source ~/.bashrc
	```
	**解决每次重启要运行 `source ~/.bashrc` **
	home目录下创建.bash_profile文件添加以下：
	
	```bash
	vim .bash_profile
	
	# 加载.bashrc文件
	if test -f .bashrc ; then
	source .bashrc
	fi
	```
	
4. 环境变量测试
	```bash
	echo $ARCH
	```
	```bash
	echo $CROSS_COMPILE
	```
	```bash
	arm-linux-gnueabihf-gcc -v
	```

## 3. BootLoader
  U-boot官网 [https://www.denx.de/wiki/U-Boot](https://www.denx.de/wiki/U-Boot)  

  源码下载页面 [http://ftp.denx.de/pub/u-boot/](http://ftp.denx.de/pub/u-boot/)  

  NXP官方 uboot 源码 Git 地址：[https://source.codeaurora.org/external/imx/uboot-imx](https://source.codeaurora.org/external/imx/uboot-imx)


  Git仓库地址 [https://e.coding.net/weidongshan/imx-uboot2017.03.git](https://e.coding.net/weidongshan/imx-uboot2017.03.git)  

  uboot更多使用讲解请参考页面 [http://wiki.100ask.org/Category:Uboot](http://wiki.100ask.org/Category:Uboot)

  u-boot官网下载的源码不能直接使用，需要根据板子修改
  不同的开发板对应不同的配置文件，配置文件位于 u-boot源码的configs/ 目录。

1. 编译U-boot镜像

* 100ask
	```bash
	cd ~/100ask_myir_mini_imx6ull-sdk/Uboot-2018.03
	make 100ask_myir_imx6ull_mini_nand_defconfig
	make
	```
    生成u-boot-dtb.imx

* MYiR
	```bash
	cd MYiR-iMX-uboot
	make distclean
	make <config>
	make
	```
	启动模式        |            编译选项
	:-:|:-:
	MYS-6ULX-IoT NAND Flash | mys_imx6ull_14x14_nand_defconfig

## 4. Linux Kernel

Linux kernel官网：[https://www.kernel.org/](https://www.kernel.org/)  
linux Kernel维基百科：[https://www.wiki.kernel.org/](https://www.wiki.kernel.org/)  
在线阅读linux kernel源码：[https://elixir.bootlin.com/](https://elixir.bootlin.com/)  

NXP 官方 kernel 源码 Git 仓库 地址
[https://source.codeaurora.org/external/imx/linux-imx](https://source.codeaurora.org/external/imx/linux-imx)

Git仓库地址： [https://e.coding.net/weidongshan/imx-linux4.9.88.git ](https://e.coding.net/weidongshan/imx-linux4.9.88.git )  
  更多关于Linux内核资料请参考页面：[http://wiki.100ask.org/Category:Linux_Operating_System](http://wiki.100ask.org/Category:Linux_Operating_System)

1. 编译Linux Kernel镜像
    配置文件位于内核源码arch/arm/configs/目录
* 100ask
	```bash
	cd Linux-4.9.88
	make mrproper
	make 100ask_myir_imx6ull_mini_defconfig
	make zImage -jN //N表示根据CPU个数，来加速编译系统
	make dtbs
	```
	```bash
	cp arch/arm/boot/zImage ~/nfs_root
	cp arch/arm/boot/dts/100ask_myir_imx6ull_mini.dtb  ~/nfs_root
	```
  编译成功后，可以得到这些文件：内核文件arch/arm/boot/zImage，设备树文件arch/arm/boot/100ask_myir_imx6ull_mini.dtb。
  把这2个文件复制到/home/ubuntu/nfs_root目录下备用。
  
2. 编译Linux Kernel模块
	```bash
	cd ~/100ask_myir_mini_imx6ull-sdk/Linux-4.9.88
	make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- modules
	```
3. 安装内核模块到Ubuntu某个目录下备用
	```bash
	cd ~/100ask_myir_mini_imx6ull-sdk/Linux-4.9.88
	sudo make ARCH=arm INSTALL_MOD_PATH=/home/ubuntu/nfs_root modules_install
	```
* MYiR
	```bash
	cd MYiR-iMX-Linux  
	make distclean
	make mys_imx6_defconfig
	make zImage dtbs modules
	```
	DTB文件|备注
	 ---|---
	mys-imx6ull-14x14-evk-gpmi-weim.dtb | MYS-6ULX-IoT NAND
	mys-imx6ull-14x14-evk-gpmi-weimmyb6ulx.dtb | MYS-6ULX-IoT NAND 上安装MYB-6ULX扩展板
	  编译完成后在"arch/arm/boot"目录会生成内核镜像文件zImage，在"arch/arm/boot/dts"目录会生成
	DTB文件。


4. 安装内核和模块到开发板上
    登录开发板挂载目录,最后重启开发板，它就使用新的zImage、dtb模块了。
	```bash
	mount -t nfs -o nolock,vers=3 193.112.167.248:/home/ubuntu/nfs_root /mnt*
	cp /mnt/zImage /boot
	cp /mnt/*.dtb /boot
	cp /mnt/lib/modules /lib -rfd
	```

## 5.使用Buildroot_2019.02LTS版构建文件系统和u-boot, kernel镜像
  Buildroot用户手册：[https://buildroot.org/downloads/manual/manual.html](https://buildroot.org/downloads/manual/manual.html)  
  BuildRoot源码下载位置：[https://buildroot.org/downloads/](https://buildroot.org/downloads/)  
  目录结构的位置以及作用请参考网址：[http://wiki.100ask.net/Buildroot](http://wiki.100ask.net/Buildroot)  
  Git仓库地址[https://e.coding.net/weidongshan/buildroot_2019.02.git](https://e.coding.net/weidongshan/buildroot_2019.02.git)  
  学习更多关于buildroot知识请参考： [http://wiki.100ask.org/Buildroot](http://wiki.100ask.org/Buildroot)  

### 1. 构建IMX6ULL mini nand版的根文件系统
  配置文件说明
  配置文件 | 含义
   -|-
  100ask_myir_imx6ull_mini_defconfig	       | 用于myir imx6ull 256MB NAND flashSD卡启动的文件系统，使用busybox init进程文件系统。
  100ask_myir_imx6ull_mini_nandflash_defconfig | 用于myir imx6ull 256MB NAND flash ubi文件系统，使用busybox init进程文件系统
  100ask_myir_imx6ull_mini_systemV_defconfig   | 用于SD卡启动的文件系统,使用systemV守护服务

1. 编译nand flash文件系统
	```bash
	cd ~/100ask_myir_mini_imx6ull-sdk/Buildroot_2019.02
	make clean
	make 100ask_myir_imx6ull_mini_nandflash_defconfig
	make all
	```
	

  编译成功后文件输出路径为 output/images： 
>buildroot2019.02
	>>├─ output
	>>>	├─ images
	>>>>├─ 100ask_myir_imx6ull_mini.dtb	<--设备树文件
			├─ rootfs.tar
			├─ rootfs.tar.bz2			<--打包并压缩的根文件系统，用于NFSROOT启动
			├─ rootfs.ubi				<--nandflash文件系统ubi格式镜像
            ├─ rootfs.ubifs
			├─ u-boot-dtb.imx			<--u-boot镜像
			└─ zImage					<--linux内核镜像 
2. 编译 SystenV服务系统
	```bash
	cd ~/100ask_myir_mini_imx6ull-sdk/Buildroot_2019.02
	make clean
	make 100ask_myir_imx6ull_mini_systemV_defconfig
	make all
	```
>buildroot2019.02
>>├── output
>>>├── images
>>>>├── 100ask_imx6ull 14x14.dtb 设备树文件
    ├── rootfs.ext2 ext2 格式根文件系 统
    ├── rootfs.ext4 --> rootfs.ext2 ext2 格式根文件系统
    ├── rootfs.tar 打包并压缩的根文件系统，用于 NFSROOT 启动
    ├── rootfs.tar.gz
    ├── sdcard.img 完整的 SD 卡系统镜像
    ├── u boot dtb.imx u boot 镜像
    └── zImage 内核镜像


## 6. 烧写更新系统
文件 |说明
-----|-----
u-boot-dtb.imx               | IMX6ULL全功能版的u-boot，烧到EMMC或SD/TF卡
u-boot-dtb_nand.imx          | IMX6ULL mini nand版的u-boot，烧到Nand
u-boot-dtb_nandsd.imx        | IMX6ULL mini nand版的u-boot，烧到SD/TF卡
zImage	                     | 内核，适用于多个板子
100ask_imx6ull-14x14.dtb     | IMX6ULL全功能版的设备树文件
100ask_myir_imx6ull_mini.dtb | IMX6ULL mini nand版的设备树文件
emmc.img	                 | IMX6ULL全功能版的EMMC映像文件
sdcard.img	                 | IMX6ULL全功能版的SD/TF卡映像文件
rootfs.ubi	                 | IMX6ULL mini nand版的Nand Flash映像文件

## 7. 开发板使用NFS根文件系统
    所谓根文件系统就是类似Windows的C盘，里面存放有必须的 APP、库文件、配置文件。
通过NFS可以把Ubuntu的某个目录，当作板子的“ C 盘”── Linux 中称之为根文件系统。
Buildroot编译完成之后生成的rootfs.tar.bz2，可以解压之后放到NFS服务器上作为
NFSROOT文件系统供开发板使用。使用NFS文件系统，便于程序的开发调试。所使用NFS
根文件文件系统之前时，我们一般还会在u-boot使用tftpboot命令从Ubuntu或Windows
中下载内核文件zImage和设备树文件，所以：Ubuntu上既要配置NFS服务，也要配置TFTP服务
0. 文件准备
	使用NFS根文件系统时，涉及3个文件：zImage、设备树(比如100ask_imx6ull-14x14.dtb)、
	rootfs.tar.bz2(解压到Ubuntu某个目录,比如/home/book/nfs_rootfs)。在U-Boot中通过
	tftpboot命令从Ubuntu/Windows中下载内核文件zImagen、100ask_imx6ull-14x14.dtb，
	设置Uboot启动参数使用Ubuntu的某个目录(比如/home/book/nfs_rootfs)作为根文件系统。
	
1. 拷贝内核和设备树文件到tftp目录：
    将zImage和100ask_myir_imx6ull_mini.dtb拷贝到/home/ubuntu/tftproot目录
    
    ```bash
    cp zImage 100ask_myir_imx6ull_mini.dtb ~/tftproot/
    ```
    
    
    
2. 把根文件系统压缩包解压到NFS目录：
  ```bash
  cd ~/100ask_myir_mini_imx6ull-sdk/Buildroot_2019.02/output/images
  cp -rf  rootfs.tar.bz2  ~/nfs_root/
  cd ~/nfs_root
  sudo tar  xjf  rootfs.tar.bz2
  ```

3. 开发板进入uboot界面 测试开发板与服务器是否联通(假设Ubuntu IP是192.168.1.224)：
  ```bash
  setenv ipaddr 192.168.1.112
  ping 192.168.1.224
  ```

4. 使用网络启动文件系统(假设Ubuntu IP是192.168.1.224)：
  1. 设置服务器的IP地址，这里指的是Ubuntu主机IP
  ```bash
  setenv serverip 192.168.1.224
  ```
  2. 设置开发板的IP地址。
  ```bash
  setenv ipaddr 192.168.1.112
  ```
  3. 设置nfs文件系统所在目录。
  ```bash
  setenv nfsroot /home/ubuntu/nfs_root
  ```
  4. 设置完成后，运行网络启动系统命令
  ```bash
  run netboot
  ```

